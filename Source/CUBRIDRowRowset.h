////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Application: CUBRID OLE DB Data Provider (http://www.cubrid.org/wiki_apis/entry/cubrid-oledb-driver)
// License: Released under a BSD license: http://www.cubrid.org/license, http://www.opensource.org/licenses/BSD-3-Clause
// Version: 8.4.1, compatible with CUBRID 8.4.1 release (http://www.cubrid.org/?mid=downloads&item=cubrid&os=detect)
// Date: March-April 2012
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#pragma once

#include "row.h"

class CCUBRIDClassRows
{
public:
	WCHAR* m_strData;

	CCUBRIDClassRows()
	{
		m_strData = new WCHAR[100];
	}

	BEGIN_PROVIDER_COLUMN_MAP(CCUBRIDClassRows)
		PROVIDER_COLUMN_ENTRY_WSTR("SET", 1, m_strData)
	END_PROVIDER_COLUMN_MAP()
};

class CCUBRIDRowRowset :
	public CSchemaRowsetImpl< CCUBRIDRowRowset, CCUBRIDClassRows, CCUBRIDRow>
{
public:
	int		m_hReq;
	char	m_szOID[15];
	char	m_colName[256];
	int		m_colIndex;

	CCUBRIDRowRowset(void) : m_hReq(0), m_colIndex(0)
	{
		m_szOID[0] = NULL;
		m_colName[0] = NULL;
	}

	~CCUBRIDRowRowset(void)
	{
		cci_close_req_handle(m_hReq);
	}

	BEGIN_PROPSET_MAP(CCUBRIDRowRowset)
		BEGIN_PROPERTY_SET(DBPROPSET_ROWSET)
		PROPERTY_INFO_ENTRY(IAccessor)
		PROPERTY_INFO_ENTRY(IColumnsInfo)
		PROPERTY_INFO_ENTRY(IConvertType)
		PROPERTY_INFO_ENTRY(IRowset)
		PROPERTY_INFO_ENTRY(IRowsetIdentity)
		PROPERTY_INFO_ENTRY(IRowsetInfo)
		PROPERTY_INFO_ENTRY(CANFETCHBACKWARDS)
		PROPERTY_INFO_ENTRY(CANHOLDROWS)
		PROPERTY_INFO_ENTRY(CANSCROLLBACKWARDS)
		PROPERTY_INFO_ENTRY_VALUE(MAXOPENROWS, 0)
		PROPERTY_INFO_ENTRY_VALUE(MAXROWS, 0)
		END_PROPERTY_SET(DBPROPSET_ROWSET)
	END_PROPSET_MAP()

	HRESULT GetConnectionHandle(int *hConn);
	HRESULT FetchData(T_CCI_SET** set);
	HRESULT Execute(LONG* pcRowsAffected, ULONG cRestrictions, const VARIANT *rgRestrictions);
	DBSTATUS GetDBStatus(CSimpleRow*, ATLCOLUMNINFO* pInfo);
};
